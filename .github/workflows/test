name: Build COPG Controller - arm64 + armv7 (Ultra Small)

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to build from'
        type: string
        required: true
        default: 'JSON'

jobs:
  build:
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch }}

      - name: Setup Android NDK r29
        run: |
          mkdir -p android-ndk
          wget -q https://dl.google.com/android/repository/android-ndk-r29-linux.zip
          unzip -q android-ndk-r29-linux.zip -d android-ndk
          NDK_PATH="$(pwd)/android-ndk/android-ndk-r29"
          echo "NDK_PATH=$NDK_PATH" >> $GITHUB_ENV
          echo "NDK ready: $NDK_PATH"

      - name: Download json.hpp
        run: |
          wget -q https://github.com/nlohmann/json/releases/download/v3.12.0/json.hpp -O json.hpp

      - name: Install UPX
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y upx-ucl

      - name: Build arm64-v8a
        run: |
          CLANG="${{ env.NDK_PATH }}/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android34-clang++"
          STRIP="${{ env.NDK_PATH }}/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-strip"

          "$CLANG" -std=c++17 -O3 -Os -fPIE -pie -static-libstdc++ \
            -fdata-sections -ffunction-sections -Wl,--gc-sections \
            -I. unified_controller.cpp -o controller_arm64

          "$STRIP" --strip-unneeded controller_arm64
          upx --best --lzma -q controller_arm64

          echo "arm64 built: $(du -h controller_arm64)"

      - name: Build armeabi-v7a (32-bit)
        run: |
          CLANG="${{ env.NDK_PATH }}/toolchains/llvm/prebuilt/linux-x86_64/bin/armv7a-linux-androideabi34-clang++"
          STRIP="${{ env.NDK_PATH }}/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-strip"

          "$CLANG" -std=c++17 -O3 -Os -fPIE -pie -static-libstdc++ \
            -fdata-sections -ffunction-sections -Wl,--gc-sections \
            -I. unified_controller.cpp -o controller_armv7

          "$STRIP" --strip-unneeded controller_armv7
          upx --best --lzma -q controller_armv7

          echo "armv7 built: $(du -h controller_armv7)"

      - name: Final report
        run: |
          echo ""
          echo "BUILD SUCCESSFUL"
          echo "controller_arm64: $(du -h controller_arm64 | cut -f1)  ($(stat -c%s controller_arm64) bytes)"
          echo "controller_armv7: $(du -h controller_armv7 | cut -f1)  ($(stat -c%s controller_armv7) bytes)"
          echo ""
          echo "No dependencies · No libc++_shared.so · Runs on any rooted Android"

      - name: Upload only the two binaries
        uses: actions/upload-artifact@v4
        with:
          name: COPG_Controller_arm64_armv7
          path: |
            controller_arm64
            controller_armv7
          retention-days: 30
