name: Test C++ Controller Build

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to test'
        type: string
        required: true
        default: 'JSON'

jobs:
  test-cpp-build:
    runs-on: ubuntu-24.04
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch }}

      - name: Setup Android NDK
        run: |
          mkdir -p android-sdk/ndk
          wget https://dl.google.com/android/repository/android-ndk-r29-linux.zip -O ndk.zip
          unzip -q ndk.zip -d android-sdk/ndk
          NDK_DIR=$(find android-sdk/ndk -maxdepth 1 -type d -name "android-ndk-r29*" | head -n 1)
          echo "NDK_PATH=$NDK_DIR" >> $GITHUB_ENV
          echo "NDK installed at: $NDK_DIR"

      - name: Download JSON library
        run: |
          wget https://github.com/nlohmann/json/releases/download/v3.12.0/json.hpp -O json.hpp

      - name: Verify C++ source file exists
        run: |
          echo "üìÅ Checking for C++ source file..."
          if [ -f "unified_controller.cpp" ]; then
            echo "‚úÖ Found unified_controller.cpp"
            echo "üìè File size: $(stat -c%s unified_controller.cpp) bytes"
          else
            echo "‚ùå unified_controller.cpp not found!"
            ls -la
            exit 1
          fi

      - name: Build for arm64-v8a (dynamic linking - like phone)
        run: |
          echo "üî® Building for arm64-v8a (dynamic linking)..."
          ${{ env.NDK_PATH }}/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android34-clang++ \
            -std=c++17 \
            -O2 \
            -fPIE \
            -I. \
            -o unified_controller_arm64 \
            unified_controller.cpp
          
          echo "‚úÖ arm64-v8a build completed"
          ls -lh unified_controller_arm64
          file unified_controller_arm64

      - name: Build for armeabi-v7a (dynamic linking - like phone)
        run: |
          echo "üî® Building for armeabi-v7a (dynamic linking)..."
          ${{ env.NDK_PATH }}/toolchains/llvm/prebuilt/linux-x86_64/bin/armv7a-linux-androideabi34-clang++ \
            -std=c++17 \
            -O2 \
            -fPIE \
            -I. \
            -o unified_controller_arm32 \
            unified_controller.cpp
          
          echo "‚úÖ armeabi-v7a build completed"
          ls -lh unified_controller_arm32
          file unified_controller_arm32

      - name: Build for arm64-v8a (optimized static)
        run: |
          echo "üî® Building for arm64-v8a (optimized static)..."
          ${{ env.NDK_PATH }}/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android34-clang++ \
            -std=c++17 \
            -Os -flto -ffunction-sections -fdata-sections \
            -static \
            -fPIE \
            -I. \
            -Wl,--gc-sections -Wl,--exclude-libs,ALL \
            -o unified_controller_arm64_static \
            unified_controller.cpp
          
          echo "‚úÖ arm64-v8a static build completed"
          ls -lh unified_controller_arm64_static

      - name: Compare binary sizes
        run: |
          echo "üìä BINARY SIZE COMPARISON:"
          echo "=========================="
          if [ -f "unified_controller_arm64" ]; then
            echo "arm64 dynamic:  $(stat -c%s unified_controller_arm64) bytes"
          fi
          if [ -f "unified_controller_arm32" ]; then
            echo "arm32 dynamic:  $(stat -c%s unified_controller_arm32) bytes"
          fi
          if [ -f "unified_controller_arm64_static" ]; then
            echo "arm64 static:   $(stat -c%s unified_controller_arm64_static) bytes"
          fi
          
          echo ""
          echo "üîç Checking dynamic dependencies:"
          if [ -f "unified_controller_arm64" ]; then
            echo "=== arm64 dynamic dependencies ==="
            ${{ env.NDK_PATH }}/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-readelf -d unified_controller_arm64 | grep "NEEDED" || true
          fi

      - name: Upload binaries as artifacts
        uses: actions/upload-artifact@v4
        with:
          name: cpp-controller-binaries
          path: |
            unified_controller_arm64
            unified_controller_arm32
            unified_controller_arm64_static
          retention-days: 1
