name: Build COPG Controller - arm64 + armv7 (Ultra Small)

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to build from'
        type: string
        required: true
        default: 'JSON'

jobs:
  build:
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch }}

      - name: Setup Android NDK r29
        run: |
          mkdir -p android-sdk/ndk
          wget -q https://dl.google.com/android/repository/android-ndk-r29-linux.zip
          unzip -q android-ndk-r29-linux.zip -d android-sdk/ndk
          NDK=$(find android-sdk/ndk -maxdepth 1 -type d -name "android-ndk-r29*" | head -n 1)
          echo "NDK_PATH=$NDK" >> $GITHUB_ENV

      - name: Download json.hpp (header-only, will be compiled in)
        run: |
          wget -q https://github.com/nlohmann/json/releases/download/v3.12.0/json.hpp -O json.hpp

      - name: Install UPX
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y upx-ucl

      - name: Build arm64-v8a (64-bit)
        run: |
          $NDK/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android34-clang++ \
            -std=c++17 -O3 -Os -fPIE -pie -static-libstdc++ \
            -fdata-sections -ffunction-sections -Wl,--gc-sections \
            -I. unified_controller.cpp -o controller_arm64
          
          $NDK/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-strip --strip-unneeded controller_arm64
          upx --best --lzma -q controller_arm64
          echo "arm64: $(du -h controller_arm64)"

      - name: Build armeabi-v7a (32-bit)
        run: |
          $NDK/toolchains/llvm/prebuilt/linux-x86_64/bin/armv7a-linux-androideabi34-clang++ \
            -std=c++17 -O3 -Os -fPIE -pie -static-libstdc++ \
            -fdata-sections -ffunction-sections -Wl,--gc-sections \
            -I. unified_controller.cpp -o controller_armv7
          
          $NDK/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-strip --strip-unneeded controller_armv7
          upx --best --lzma -q controller_armv7
          echo "armv7: $(du -h controller_armv7)"

      - name: Final sizes
        run: |
          echo ""
          echo "BUILD COMPLETE"
          echo "controller_arm64 → $(du -h controller_arm64 | cut -f1) ($(stat -c%s controller_arm64) bytes)"
          echo "controller_armv7 → $(du -h controller_armv7 | cut -f1) ($(stat -c%s controller_armv7) bytes)"
          echo ""
          echo "Zero dependencies. No libc++_shared.so. Runs anywhere."

      - name: Upload binaries only
        uses: actions/upload-artifact@v4
        with:
          name: COPG_Controller_Binaries_ONLY
          path: |
            controller_arm64
            controller_armv7
          retention-days: 30
